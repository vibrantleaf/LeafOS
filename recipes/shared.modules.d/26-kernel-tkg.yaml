modules:
  - type: dnf
    repos:
      copr:
        - "whitehara/kernel-tkg"
    remove:
      auto-remove: true
      packages:
        - "kmod-openrazer"
        - "kmod-v4l2loopback" 
        - "kmod-xone"
        - "kmod-zfs"
        - "openrazer-kmod-common"
        - "ublue-os-akmods-addons"
        - "xone-kmod-common"
        - "framework-laptop-kmod-common"
    install:
      packages:
        - "sbsigntools"
  - type: script
    snippets:
      - "dnf5 -y config-manager setopt '*kernel-tkg*'.priority=0"
      - "dnf5 -y versionlock delete kernel"
      - "dnf5 -y versionlock delete kernel-core"
      - "dnf5 -y versionlock delete kernel-modules"
      - "dnf5 -y versionlock delete kernel-devel"
      - "dnf5 -y versionlock delete kernel-modules-core"
      - "dnf5 -y versionlock delete kernel-modules-extra"
      - "dnf5 -y update --refresh"
      - "rpm-ostree override replace --experimental --from repo='copr:copr.fedorainfracloud.org:whitehara:kernel-tkg' kernel kernel-core kernel-modules kernel-modules-core kernel-modules-extra kernel-devel-matched kernel-devel"
      - "dnf5 update -y --refresh"
  - type: akmods
    base: main
    install:
      - "openrazer"
      - "v412loopback"
      - "framework-laptop"
      - "kvmfr"
      - "wl"
      - "xone"
      - "system76"
      - "system76-io"
      - "zenergy"
      - "gcadapter_oc"
      - "ryzen-smu"
      - "nct6687d"
      - "evdi"
      - "bmi260"
      - "ayaneo-platform"
      - "ayn-platform"
      - "gpd-fan"
  - type: script
    scripts:
      - "shared/15-sign-tkg-kernel.sh" # FIX ME
    ###
    secrets:
      - type: env
        name: MOK_PRIV
        mount:
          type: file
          destination: /tmp/certs/mok.priv
      - type: env
        name: MOK_DER
        mount:
          type: file
          destination: /tmp/certs/mok.der
    #  yoinked from: https://github.com/secureblue/secureblue/blob/live/recipes/common/common-modules.yml
    ####
  - type: dnf
    remove:
      auto-remove: true
      packages:
        - "sbsigntools"
